# ALE-8477: ExportsV2 "This Event" Download Flow

This diagram shows the complete flow for downloading a single event using the new exportsV2 API.

```mermaid
sequenceDiagram
    actor User
    participant Button as This Event Button
    participant Handler as Event Handler
    participant SendReq as sendDownloadRequest()
    participant ApiClient as publicApiClient
    participant API as Public API
    participant EventSource as EventSource
    participant ESHandler as onDownloadEventSourceMessage()
    participant Complete as completeDownloadJob()
    participant Poll as pollExportDownloads()
    participant Downloads as Downloads API
    participant Browser as Browser
    
    User->>Button: Click This Event
    Note over Button: {<br/>"data-event-download": "instant",<br/>"data-start": "...",<br/>"data-end": "...",<br/>"data-camera": "..."<br/>}
    
    Button->>Handler: Click event with dataset
    Handler->>Handler: queueEventForInstantDownload(eventData)
    
    Note over Handler: Extract camera, start, end. Apply event bounds if needed. Convert to ISO date format
    
    Handler->>SendReq: await sendDownloadRequest(requestParams)
    Note over SendReq: {<br/>"cameraHash": "...",<br/>"start": "ISO date",<br/>"end": "ISO date",<br/>"storage": "Cloud"<br/>}
    
    SendReq->>ApiClient: requestCameraExport(cameraHash, 'Batch', start, end, 'Cloud')
    
    Note over ApiClient: ExportsV2Body:<br/>{<br/>"type": "Batch",<br/>"start": "ISO date",<br/>"end": "ISO date",<br/>"storage": "Cloud"<br/>}
    
    ApiClient->>API: POST /v1/cameras/{id}/exportsV2 with ExportsV2Body
    API-->>ApiClient: {<br/>"exportId": "...",<br/>"status": "Queued",<br/>"..."<br/>}
    ApiClient-->>SendReq: response
    SendReq-->>Handler: job response
    
    Handler->>Handler: isValidDownloadJob(job)
    Note over Handler: Check job.exportId exists
    
    Handler->>Handler: asSapiJob(job)
    Note over Handler: Convert exportsV2 format (exportId to jobId, expiresOn to expiry, cameraId to cameraHash)
    
    Handler->>Handler: addDownloadJob(sapiJob)
    Note over Handler: Add to downloadJobsManifest and start 15s timeout
    
    Handler->>EventSource: Establish SSE connection (if not already connected)
    
    loop Poll for job status
        EventSource-->>ESHandler: {<br/>"jobs": [{<br/>"jobId": "...",<br/>"status": "...",<br/>"..."<br/>}]<br/>}
        
        ESHandler->>ESHandler: Parse jobs array
        ESHandler->>ESHandler: Check if job.jobId in manifest
        ESHandler->>ESHandler: Update manifest with job data
        ESHandler->>ESHandler: checkDownloadJob(jobId)
        
        alt Status RUNNING or QUEUED
            Note over ESHandler: Continue monitoring
        else Status FAILED
            ESHandler->>ESHandler: failDownloadJob(job)
            ESHandler->>User: Show error toast
        else Status COMPLETE or SUCCESS
            ESHandler->>Complete: completeDownloadJob(job)
        end
    end
    
    Note over Complete: Job completed - now fetch download URL
    
    Complete->>Poll: await pollExportDownloads(exportId)
    
    loop Poll until presignedURL available (max 30 attempts)
        Poll->>Poll: fetchExportDownloads(exportId)
        Poll->>Downloads: GET /v1/exportsV2/{exportId}/downloads
        Downloads-->>Poll: {<br/>"presignedURL": null or "https://..."<br/>}
        
        alt presignedURL not ready
            Note over Poll: Wait 1 second
            Poll->>Poll: setTimeout(1000)
        else presignedURL ready
            Poll-->>Complete: {<br/>"presignedURL": "https://..."<br/>}
        end
    end
    
    Complete->>Complete: downloadJobsManifest.delete(exportId)
    Complete->>User: Hide waiting dialog
    Complete->>User: Show success toast Event download completed
    
    Complete->>Complete: triggerUrlDownload(presignedURL)
    Complete->>Browser: Create anchor element with href=presignedURL
    Browser->>User: Download file
    
    Note over User,Browser: Download complete!
```

## Key Components

### 1. sendDownloadRequest()
- Takes request parameters (cameraHash, start, end, storage)
- Calls `publicApiClient.requestCameraExport()` with individual parameters
- Returns the export job response with `exportId`

### 2. publicApiClient.requestCameraExport()
- Located in: `~/camcloud/repos/tpl_shared/js/scripts.js`
- Builds the ExportsV2Body payload: `{ type: 'Batch', start, end, storage }`
- POSTs to `/v1/cameras/{id}/exportsV2`

### 3. EventSource Monitoring
- Monitors job status via SSE stream at `/settings?task=eventsource.status`
- Receives updates with job status changes
- Legacy format uses `jobId` field name (but contains exportId value)

### 4. pollExportDownloads()
- Polls `/v1/exportsV2/{exportId}/downloads` endpoint
- Checks every 1 second for up to 30 seconds
- Returns immediately when `presignedURL` is available
- Throws error if URL not available after max attempts

### 5. completeDownloadJob()
- Called when EventSource reports job as COMPLETE
- Polls for download URL using `pollExportDownloads()`
- Triggers browser download when URL is ready
- Handles errors and shows appropriate user notifications

## API Endpoints

1. **Create Export**: `POST /v1/cameras/{id}/exportsV2`
   - Request Body: `{ type: 'Batch', start, end, storage }`
   - Response: `{ exportId, status: 'Queued', ... }`

2. **Get Download URL**: `GET /v1/exportsV2/{exportId}/downloads`
   - Response: `{ presignedURL: "https://..." }`
   - May return `null` initially, requires polling

3. **Monitor Status**: `GET /settings?task=eventsource.status` (SSE)
   - Streams job status updates
   - Message format: `{ jobs: [{ jobId, status, ... }] }`

## Data Flow

1. User clicks "This Event" button
2. Export job created with exportsV2 API
3. Job added to manifest for tracking
4. EventSource monitors job status
5. When job completes, start polling for download URL
6. Once URL available, trigger browser download
7. Clean up manifest and show success message
